<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Steroid Calculator & Plotter</title>
  <style>
    body { background: #1c1c1c; color: #f9f9f9; font-family: sans-serif; padding: 30px; }
    .container { max-width: 900px; margin: auto; padding: 20px; background: #1c1c1c; border: 1px solid #7a7a7a; border-radius: 10px; }
    label, input, select { display: block; width: 100%; margin-top: 10px; }
    input, select { padding: 8px; background: #111; border: 1px solid #7a7a7a; border-radius: 5px; color: #f9f9f9; }
    button { background: #b73239; color: white; padding: 12px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    .compound-block { border-top: 1px solid #7a7a7a; padding-top: 15px; margin-top: 20px; }
    .results { margin-top: 30px; padding: 20px; background: #111; border: 1px solid #7a7a7a; border-radius: 10px; }
  </style>
</head>
<body>

  <div class="container">
    <h2>Injection Calculator & Blood Level Plotter</h2>

    <label>Number of Compounds</label>
    <input type="number" id="compoundCount" value="1" min="1" max="10" onchange="renderCompounds()" />

    <div id="compoundContainer"></div>

    <label>Injection Frequency (per week)</label>
    <select id="frequency">
      <option value="7">Every day (7x)</option>
      <option value="6">6x</option>
      <option value="5">5x</option>
      <option value="4">4x (Mon/Wed/Fri/Sun)</option>
      <option value="3">Every other day (~3x)</option>
      <option value="2">2x (e.g. Mon/Thu)</option>
      <option value="1">Once a week</option>
    </select>

    <label>Cycle Duration (weeks)</label>
    <input type="number" id="cycleWeeks" value="12" min="1" />

    <button onclick="calculate()">Calculate & Plot</button>

    <div id="resultBox" class="results"></div>
    <canvas id="chart" style="margin-top: 40px;"></canvas>
  </div>

  <!-- Chart.js and Annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script>
    // Must register the annotation plugin for it to take effect
    Chart.register(window['chartjs-plugin-annotation']);
  </script>

  <script>
    const steroidData = {
      "Boldenone Cypionate": 144, "Boldenone Undecylenate": 336, "Dihydroboldenone Cypionate": 144,
      "Drostanolone Enanthate": 120, "Drostanolone Propionate": 48, "Methandione Injectable": 6,
      "Methyldrostanolone Injectable": 12, "Methenolone Enanthate": 120, "Methenolone Acetate": 4,
      "Nandrolone Decanoate": 192, "Nandrolone Phenylpropionate": 96, "Stanozolol Suspension": 24,
      "Testosterone Acetate": 48, "Testosterone Base": 2, "Testosterone Cypionate": 144,
      "Testosterone Decanoate": 192, "Testosterone Enanthate": 120, "Testosterone Isocaproate": 144,
      "Testosterone Phenylpropionate": 96, "Testosterone Propionate": 48, "Testosterone Suspension": 24,
      "Testosterone Undercanoate": 1000, "Trestolone Acetate": 48, "Trestolone Enanthate": 120,
      "Trenbolone Acetate": 48, "Trenbolone Base": 6, "Trenbolone Enanthate": 120,
      "Trenbolone Hexahydrobenzyl Carbonate": 144,

      "Chlordehydromethyltestosterone": 12, "Fluoxymesterone Oral": 9, "Methandione Oral": 4,
      "Methyl-1-testosterone Oral": 4, "Methyldrostanolone Oral": 6, "Methylstenbolone Oral": 4,
      "Metribolone Oral": 6, "Oxandrolone Oral": 9, "Oxymetholone Oral (Anadrol)": 8,
      "Stanozolol Oral": 9,

      "Custom": null
    };

    function renderCompounds() {
      const container = document.getElementById("compoundContainer"), count = parseInt(document.getElementById("compoundCount").value);
      container.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const div = document.createElement("div");
        div.className = "compound-block";
        const injectables = Object.entries(steroidData).filter(([k]) => !k.includes("Oral") && k !== "Custom")
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([k,v]) => `<option value="${k}">${k} (${v}h)</option>`).join("");
        const orals = Object.entries(steroidData).filter(([k]) => k.includes("Oral"))
          .sort((a,b) => a[0].localeCompare(b[0]))
          .map(([k,v]) => `<option value="${k}">${k} (${v}h)</option>`).join("");
        div.innerHTML = `
          <label>Compound ${i+1}</label>
          <select id="compound_${i}" onchange="toggleHalfLife(${i})">
            <optgroup label="Injectables">${injectables}</optgroup>
            <optgroup label="Orals">${orals}</optgroup>
            <optgroup label="Custom"><option value="Custom">Custom (enter manually)</option></optgroup>
          </select>
          <div id="customHL_${i}" style="display:none;">
            <label>Custom Half‑Life (h)</label>
            <input type="number" id="halfLife_${i}" />
          </div>
          <label>Weekly Dose (mg)</label><input type="number" id="weeklyDose_${i}" />
          <label>Concentration (mg/ml)</label><input type="number" id="concentration_${i}" />
          <label>Vial Size (ml)</label><input type="number" id="vialSize_${i}" />
        `;
        container.appendChild(div);
      }
    }

    function toggleHalfLife(i) {
      document.getElementById(`customHL_${i}`).style.display = document.getElementById(`compound_${i}`).value === "Custom" ? "block" : "none";
    }

    renderCompounds();

    let chart;
    function calculate() {
      const freq = parseFloat(document.getElementById("frequency").value);
      const weeks = parseFloat(document.getElementById("cycleWeeks").value);
      const baseDays = weeks * 7;
      const compoundCount = parseInt(document.getElementById("compoundCount").value);
      const resultBox = document.getElementById("resultBox");
      resultBox.innerHTML = "";

      const halfLives = Array.from({length:compoundCount}, (_, i) => {
        const n = document.getElementById(`compound_${i}`).value;
        const c = parseFloat(document.getElementById(`halfLife_${i}`)?.value || 0);
        return n === "Custom" ? c : steroidData[n];
      });
      const maxHL = Math.max(...halfLives);
      const totalDays = baseDays + Math.ceil((maxHL * 7) / 24);
      const labels = Array.from({length: totalDays}, (_, i) => `Day ${i+1}`);
      const datasets = [];
      let totalWeekly=0, totalInj=0, latestClr=0;

      for (let i = 0; i < compoundCount; i++) {
        const name = document.getElementById(`compound_${i}`).value;
        const halfLife = name === "Custom" ? parseFloat(document.getElementById(`halfLife_${i}`).value) : steroidData[name];
        const dose = parseFloat(document.getElementById(`weeklyDose_${i}`).value);
        const conc = parseFloat(document.getElementById(`concentration_${i}`).value);
        const vial = parseFloat(document.getElementById(`vialSize_${i}`).value);
        if (!halfLife || !dose|| !conc|| !vial) return alert(`Complete all fields for compound ${i+1}`);
        const weeklyML = dose / conc, perInj = weeklyML / freq, totalML = weeklyML * weeks, vials = totalML / vial;
        totalWeekly += weeklyML; totalInj += perInj;
        const decay = Math.log(2) / halfLife, data = Array(totalDays).fill(0);
        for (let d=0; d<totalDays; d++){
          data[d] = d < baseDays
            ? Array.from({length: Math.floor(d/(7/freq))+1}, (_, inj) => perInj * Math.exp(-decay*(d-inj*((7/freq)))*24)).reduce((a,b)=>a+b,0)
            : data[d-1]*Math.exp(-decay*24);
        }
        let clr = data.findIndex(v=>v < perInj*0.01);
        clr = clr < 0 ? totalDays : clr;
        if (clr > latestClr) latestClr = clr;
        const postWeeks = Math.max(0, Math.floor((clr+1-baseDays)/7));
        resultBox.innerHTML += `<strong>${name}</strong><br>Weekly: ${weeklyML.toFixed(2)}ml<br>Per Inj: ${perInj.toFixed(2)}ml<br>Vials: ${vials.toFixed(1)}<br>Clears Day ${clr+1} (~${postWeeks} wks post cycle)<br><br>`;
        datasets.push({label:name, data, borderColor:getRandomColor(), fill:false, tension:0.3});
      }
      const allPost = Math.max(0, Math.floor((latestClr+1-baseDays)/7));
      resultBox.innerHTML += `<hr>Total Weekly: ${totalWeekly.toFixed(2)}ml<br>Total Per Inj: ${totalInj.toFixed(2)}ml<br><strong>All Clear By:</strong> Day ${latestClr+1} (~${allPost} wks post cycle)<br>`;

      if(chart) chart.destroy();
      const ctx = document.getElementById("chart").getContext("2d");
      chart = new Chart(ctx, {
        type:'line',
        data:{labels, datasets},
        options:{
          responsive:true,
          plugins:{
            legend:{labels:{color:'#f9f9f9'}},
            annotation:{
              annotations:{
                pctLine:{type:'line', xScaleID:'x', value: labels[latestClr], borderColor:'#e2a53e', borderWidth:2, borderDash:[6,6], label:{enabled:true, content:'📍 PCT Start', position:'start', backgroundColor:'#e2a53e', color:'#1c1c1c', font:{weight:'bold'}}}
              }
            }
          },
          scales:{x:{ticks:{color:'#f9f9f9'}, title:{display:true,text:'Days',color:'#f9f9f9'}}, y:{ticks:{color:'#f9f9f9'}, title:{display:true,text:'Active Level',color:'#f9f9f9'}}}
        }
      });
    }

    function getRandomColor(){ const [r,g,b] = Array(3).fill().map(_=>Math.floor(Math.random()*200)); return `rgb(${r},${g},${b})`; }
  </script>
</body>
</html>
